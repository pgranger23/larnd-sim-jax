variables:
  # Clone the repo deeply so we can push back to it
  GIT_DEPTH: 0
  # Use your docker image which already has JAX+CUDA
  # Ensure this image is public on Docker Hub or add authentication
  DOCKER_IMAGE: "pigranger/larndsim-jax:latest"

stages:
  - gpu-tests
  - sync-artifacts

# Template for all GPU jobs to avoid repetition
.gpu_template:
  image: $DOCKER_IMAGE
  tags:
    - k8s-gpu
  before_script:
    # Ensure we are testing the LATEST code from the commit, not the old code in the docker image
    - pip install .[dev] pytest-xdist
  artifacts:
    paths:
      - output/*.png
      - fit_result/**/*.pkl
    expire_in: 1 week

# --- Jobs migrated from main.yml ---

test-fit:
  extends: .gpu_template
  script:
    - ./optimize/fit_test.sh
    - python3 ./optimize/analysis_scripts/plot_fit.py --input_file fit_result/**/*.pkl --output_dir output

test-fit-lut:
  extends: .gpu_template
  script:
    - ./optimize/fit_test.sh --lut
    - python3 ./optimize/analysis_scripts/plot_fit.py --input_file fit_result/**/*.pkl --output_dir output

test-scan:
  extends: .gpu_template
  script:
    - ./optimize/scan_test.sh
    - python3 ./optimize/analysis_scripts/plot_scan.py --input_file fit_result/**/*.pkl --output_dir output

test-scan-lut:
  extends: .gpu_template
  script:
    - ./optimize/scan_lut_test.sh
    - python3 ./optimize/analysis_scripts/plot_scan.py --input_file fit_result/**/*.pkl --output_dir output

test-minuit:
  extends: .gpu_template
  script:
    - ./optimize/minuit_test.sh

# --- The "Round Trip" Job ---
# This gathers all plots from previous jobs and pushes them to GitHub
push-plots-back:
  stage: sync-artifacts
  image: alpine/git
  needs: [test-fit, test-fit-lut, test-scan, test-scan-lut]
  script:
    - git config --global user.email "gitlab-ci@cern.ch"
    - git config --global user.name "CERN GPU Runner"
    # Authenticate using the secret GITHUB_TOKEN
    - git remote set-url origin https://oauth2:${GITHUB_TOKEN}@github.com/pgranger23/larnd-sim-jax.git
    
    # Checkout main and pull latest changes to avoid conflicts
    - git checkout main
    - git pull origin main --rebase
    
    # Add the plots generated by the GPU jobs
    - git add output/*.png
    
    # Commit with [skip ci] to prevent an infinite loop of builds
    - git commit -m "Update simulation plots from CERN GPU [skip ci]" || echo "No changes to commit"
    
    # Push back to GitHub
    - git push origin main
    
    # OPTIONAL: Manually trigger RTD if the push doesn't do it automatically
    # - apk add curl
    # - curl -X POST -d "branches=main" -d "token=${RTDS_WEBHOOK_TOKEN}" ${RTDS_WEBHOOK_URL}