variables:
  GIT_DEPTH: 0
  DOCKER_IMAGE: "pigranger/larndsim-jax:latest"

stages:
  - gpu-tests
  - sync-artifacts

# --- Template Fix ---
.gpu_template:
  stage: gpu-tests  # <--- THIS WAS MISSING
  image: $DOCKER_IMAGE
  tags:
    - k8s-gpu
  before_script:
    - pip install .[dev] pytest-xdist
  artifacts:
    paths:
      - output/*.png
      - fit_result/**/*.pkl
    expire_in: 1 week

# --- Jobs ---

test-fit:
  extends: .gpu_template
  script:
    - ./optimize/fit_test.sh
    - python3 ./optimize/analysis_scripts/plot_fit.py --input_file fit_result/**/*.pkl --output_dir output

test-fit-lut:
  extends: .gpu_template
  script:
    - ./optimize/fit_test.sh --lut
    - python3 ./optimize/analysis_scripts/plot_fit.py --input_file fit_result/**/*.pkl --output_dir output

test-scan:
  extends: .gpu_template
  script:
    - ./optimize/scan_test.sh
    - python3 ./optimize/analysis_scripts/plot_scan.py --input_file fit_result/**/*.pkl --output_dir output

test-scan-lut:
  extends: .gpu_template
  script:
    - ./optimize/scan_lut_test.sh
    - python3 ./optimize/analysis_scripts/plot_scan.py --input_file fit_result/**/*.pkl --output_dir output

test-minuit:
  extends: .gpu_template
  script:
    - ./optimize/minuit_test.sh

# --- Sync Job ---

push-plots-back:
  stage: sync-artifacts
  image: alpine/git
  needs: [test-fit, test-fit-lut, test-scan, test-scan-lut]
  script:
    - git config --global user.email "gitlab-ci@cern.ch"
    - git config --global user.name "CERN GPU Runner"
    - git remote set-url origin https://oauth2:${GITHUB_TOKEN}@github.com/pgranger23/larnd-sim-jax.git
    - git checkout main
    - git pull origin main --rebase
    - git add output/*.png
    - git commit -m "Update simulation plots from CERN GPU [skip ci]" || echo "No changes to commit"
    - git push origin main